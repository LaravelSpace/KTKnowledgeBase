## TCP协议的三次握手和四次挥手

### 三次握手（Three-Way Handshake）

TCP通过三次握手保证传输任务的可靠。TCP三次握手就好比客户端与服务器看见了对方，但是不能100%确认，所以要通过握手的方式相互确定对方。三次握手即TCP连接的建立。这个连接必须是一方主动打开，另一方被动打开的。以下为客户端主动发起连接的图解：

![](E:\GongZuoQu\KTZhiShiKu\Image\WangLuoGongCheng\TCPXieYi_img04.jpeg)

握手之前主动打开连接的客户端结束CLOSED阶段，被动打开的服务器也结束CLOSED阶段，并进入LISTEN阶段。随后开始三次握手：

1、首先客户端向服务器发出请求连接，即SYN=1，ACK=0。TCP规定SYN=1时不能携带数据，但要消耗一个序号，因此声明自己的序号是seq=x（x一般为1）。随后客户端进入SYN-SENT阶段。

2、服务器接收到来自客户端的TCP报文之后，结束LISTEN阶段。并返回一段TCP报文进行回复确认，即SYN=1，ACK=1，seq=y，ack=x+1。标志位为SYN和ACK，表示确认客户端的报文seq序号有效，服务器能正常接收客户端发送的数据，并同意创建新连接。确认号为ack=x+1，表示收到客户端的序号seq并将其值加1作为自己确认号ack的值。随后服务器进入SYN-RCVD阶段。

3、客户端接收到来自服务器的确认收到数据的TCP报文之后，明确了从客户端到服务器的数据传输是正常的，结束SYN-SENT阶段，并返回最后一段TCP报文。这次ACK=1，seq=x+1，ack=y+1，不用SYN了。标志位为ACK，表示确认收到服务器同意连接的信号。序号为seq=x+1，表示收到服务器的确认号ack，并将其值作为自己的序号值。确认号为ack=y+1，表示收到服务器序号seq，并将其值加1作为自己的确认号ack的值。随后客户端进入ESTABLISHED阶段。服务器收到来自客户端的确认收到服务器数据的TCP报文之后，明确了从服务器到客户端的数据传输是正常的，结束SYN-SENT阶段，进入ESTABLISHED阶段。

这里别把AKC标志位和ack确认号搞混了，这两个东西不一样。

seq是序列号，这是为了连接以后传送数据用的，ack是对收到的数据包的确认，值是等待接收的数据包的序列号。seq是数据包本身的序列号，ack是期望对方继续发送的那个数据包的序列号。

- 第一次，客户端随机选取一个序列号作为自己的初始序号发送给服务器；
- 第二次，服务器使用ack对客户端的数据包进行确认，因为已经收到了序列号为x的数据包，准备接收序列号为x+1的包，所以ack=x+1，同时服务器告诉客户端自己的初始序列号，就是seq=y；
- 第三条，客户端告诉服务器收到了服务器的确认消息并准备建立连接，客户端自己此条消息的序列号是x+1，所以seq=x+1，而ack=y+1是表示客户端正准备接收服务器序列号为y+1的数据包。

在客户端与服务器传输的TCP报文中，双方的确认号ack和序号seq的值，都是在彼此ack和seq值的基础上进行计算的，这样做保证了TCP报文传输的连贯性。一旦出现某一方发出的TCP报文丢失，便无法继续握手，以此确保了三次握手的顺利完成。

#### 三次握手的作用

三次握手的作用主要是保证客户端到服务器之间建立了有效的连接。一是防止服务端无用的连接增加服务器开销。二是防止已失效的连接的报文突然又传送到了服务端，从而产生错误。

网络传输是有延时的。在传输的过程中，客户端发起了SYN=1创建连接的请求。如果服务器返回给客户端的包含SYN、ACK和seq等内容的数据包因为网络传输的原因丢失了，丢失之后客户端就没有接收到服务器返回的数据包。

可能客户端设置了一个超时时间，时间到了就关闭了连接创建的请求，再重新发出创建连接的请求，而服务器是不知道的。如果没有第三次握手告诉服务器客户端收到了到服务器传输的数据的话，服务器是不知道客户端有没有接收到服务器返回的信息的。

这样没有给服务器一个创建还是关闭连接端口的请求，服务器的端口就一直开着，等到客户端因超时重新发出请求时，服务器就会重新开启一个端口连接。那么服务器上没有接收到请求数据的上一个端口就一直开着，这样的端口多了，就会造成服务器开销的严重浪费。所以我们需要第三次握手来确认这个过程，让客户端和服务器能够及时地察觉到因为网络等一些问题导致的连接创建失败，这样服务器的端口就可以关闭了，不用一直等待。

### 四次挥手（Four-Way Wavehand）

所谓的四次挥手即TCP连接的释放(解除)。连接的释放必须是一方主动释放，另一方被动释放。中断连接端可以是客户端，也可以是服务器。以下为客户端主动发起释放连接的图解：

![](E:\GongZuoQu\KTZhiShiKu\Image\WangLuoGongCheng\TCPXieYi_img05.jpeg)

挥手之前主动释放连接的客户端结束ESTABLISHED阶段。随后开始四次挥手：

1、首先客户端想要释放连接，向服务器发送一段TCP报文，FIN=1，ack=u。标记位为FIN，表示请求释放连接。随后客户端进入FIN-WAIT-1阶段，即半关闭阶段。并且停止在客户端到服务器方向上发送数据，但是客户端仍然能接收从服务器传输过来的数据。需要注意的是吗，这里不发送的是正常连接时传输的数据，而不是一切数据，客户端仍然能发送ACK确认报文。

2、服务器接收到从客户端发出的TCP报文之后，确认了客户端想要释放连接，随后服务器结束ESTABLISHED阶段，进入CLOSE-WAIT阶段（半关闭状态）并返回一段TCP报文，ACK=1，seq=v，ack=u+1。标记位为ACK，表示接收到客户端发送的释放连接的请求。随后服务器开始准备释放服务器到客户端方向上的连接。客户端收到从服务器发出的TCP报文之后，确认了服务器收到了客户端发出的释放连接请求，随后客户端结束FIN-WAIT-1阶段，进入FIN-WAIT-2阶段。

> 前两次挥手既让服务器知道了客户端想要释放连接，也让客户端知道了服务器了解了自己想要释放连接的请求。于是，可以确认关闭客户端到服务器方向上的连接了。

3、服务器自从发出ACK确认报文之后，经过CLOSED-WAIT阶段，做好了释放服务器到客户端方向上的连接准备，再次向客户端发出一段TCP报文，FIN=1，ACK=1，seq=w，ack=u+1。标记位为FIN和ACK，表示已经准备好释放连接了。注意一下这里的ACK并不是确认收到服务器报文的确认报文。确认号为ack=u+1，表示是在收到客户端报文的基础上，将其序号seq值加1作为本段报文确认号ack的值。随后服务器结束CLOSE-WAIT阶段，进入LAST-ACK阶段。并且停止在服务器到客户端的方向上发送数据，但是服务器仍然能够接收从客户端传输过来的数据。

4、客户端收到从服务器发出的TCP报文，确认了服务器已做好释放连接的准备，结束FIN-WAIT-2阶段，进入TIME-WAIT阶段，并向服务器发送一段报文，ACK=1，seq=u+1，ack=w+1。标记位为ACK，表示“接收到服务器准备好释放连接的信号”。序号为seq=u+1，表示是在收到了服务器报文的基础上，将其确认号ack值作为本段报文序号的值。确认号为ack=w+1，表示是在收到了服务器报文的基础上，将其序号seq值作为本段报文确认号的值。随后客户端开始在TIME-WAIT阶段等待2MSL。

服务器收到从客户端发出的TCP报文之后结束LAST-ACK阶段，进入CLOSED阶段。由此正式确认关闭服务器到客户端方向上的连接。客户端等待完2MSL之后，结束TIME-WAIT阶段，进入CLOSED阶段，由此完成四次挥手。

> 后两次挥手既让客户端知道了服务器准备好释放连接了，也让服务器知道了客户端了解了自己准备好释放连接了。于是，可以确认关闭服务器到客户端方向上的连接了，由此完成四次挥手。

#### 为什么挥手是四次

TCP建立连接时之所以只需要三次握手，是因为在第二次"握手"过程中，服务器发送给客户端的TCP报文是以SYN与ACK作为标志位的。SYN是请求连接标志，表示服务器同意建立连接；ACK是确认报文，表示告诉客户端，服务器收到了它的请求报文。即SYN建立连接报文与ACK确认接收报文是在同一次"握手"当中传输的，所以三次握手不多也不少，正好让双方明确彼此信息互通。

TCP释放连接时之所以需要四次挥手,是因为ACK确认接收报文和FIN释放连接报文是分别由第二次和第三次挥手传输的。建立连接时，被动方服务器结束CLOSED阶段进入握手阶段并不需要任何准备，可以直接返回SYN和ACK报文，开始建立连接。释放连接时，被动方服务器，突然收到主动方客户端释放连接的请求时并不能立即释放连接，因为还有必要的数据需要处理，所以服务器先返回ACK确认收到报文，经过CLOSE-WAIT阶段准备好释放连接之后，才能返回FIN释放连接报文。

#### 为什么客户端在TIME-WAIT阶段要等2MSL

为的是确认服务器是否收到客户端发出的ACK确认报文。

当客户端发出最后的ACK确认报文时，并不能确定服务器能够收到该段报文。所以客户端在发送完ACK确认报文之后，会设置一个时长为2MSL的计时器。MSL指的是Maximum Segment Lifetime，即一段TCP报文在传输过程中的最大生命周期。2MSL即是服务器发出为FIN报文和客户端发出的ACK确认报文所能保持有效的最大时长。当服务器在1MSL内没有收到客户端发出的ACK确认报文，就会再次向客户端发出FIN报文。

如果客户端在2MSL内，再次收到了来自服务器的FIN报文，说明服务器由于各种原因没有接收到客户端发出的ACK确认报文。客户端再次向服务器发出ACK确认报文，计时器重置，重新开始2MSL的计时。否则客户端在2MSL内没有再次收到来自服务器的FIN报文，说明服务器正常接收了ACK确认报文，客户端可以进入CLOSED阶段，完成四次挥手。