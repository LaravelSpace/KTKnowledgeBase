```json
{
  "updated_at": "2020-07-29",
  "updated_by": "KelipuTe",
  "tags": "网络工程,Network Engineering,TCP"
}
```

---

## TCP协议简介

互联网由一整套协议构成。TCP只是其中的一层，有着自己的分工。TCP是以太网协议和IP协议的上层协议，也是应用层协议的下层协议。

最底层的以太网协议（Ethernet）规定了电子信号如何组成数据包（packet），解决了子网内部（局域网）的点对点通信。但是，以太网协议不能解决多个局域网如何互通，这由IP协议解决，IP协议可以连接多个局域网。

IP协议定义了一套自己的地址规则，称为IP地址。它实现了路由功能，允许某个局域网的A主机，向另一个局域网的B主机发送消息。路由器就是基于IP协议，局域网之间要靠路由器连接。路由的原理很简单，路由器背后都有很多网口，要接入多根网线。路由器内部有一张路由表，路由表注明了不同IP目的地的数据包，要发送到哪一个网口（interface）。比如，规定了A段IP地址走出口一，B段地址走出口二，......通过这套指路牌，实现了数据包的转发。

但是IP协议只是一个地址协议，并不保证数据包的完整。如果路由器丢包（比如缓存满了，新进来的数据包就会丢失），就需要发现丢了哪一个包，以及如何重新发送这个包。这就要依靠TCP协议。简单说，TCP协议的作用是，保证数据通信的完整性和可靠性，防止丢包。

### TCP与HTTP

收到TCP数据包以后，组装还原是操作系统完成的。应用程序不会直接处理TCP数据包。操作系统不会去处理 TCP数据包里面的数据。一旦组装好TCP数据包，就把它们转交给应用程序。

TCP数据包里面有一个端口（port）参数，就是用来指定转交给监听该端口的应用程序。系统根据TCP数据包里面的端口，将组装好的数据转交给相应的应用程序。比如，21端口是FTP服务器，25端口是SMTP服务，80端口是Web服务器。

对于应用程序来说，不用关心数据通信的细节。除非线路异常，收到的总是完整的数据。应用程序需要的数据放在TCP数据包里面，有自己的格式（比如HTTP协议）。

TCP不存在连接的概念，只存在请求和响应，请求和响应都是数据包。它们之间都是经过由TCP创建的一个客户端发起，服务器接收的类似连接的通道。这个连接可以一直保持，HTTP请求是在这个连接的基础上发送的。在一个TCP连接上是可以发送多个HTTP请求的，不同的版本这个模式不一样。

- HTTP/1.0中这个TCP连接是在HTTP请求创建的时候同步创建的，HTTP请求发送到服务器，服务器响应了之后，这个TCP连接就关闭了。
- HTTP/1.1中这个连接一直保持，一个请求传输完之后，另一个请求可以接着传输。在创建一个TCP连接的过程中需要三次握手的消耗，三次握手代表有三次网络传输。如果TCP连接保持，第二个请求发送就没有这三次握手的消耗。
- HTTP/2中同一个TCP连接里还可以并发地传输HTTP请求。

### TCP报文格式

![](E:\Workspace\KTKnowledgeBase\Image\WangLuoGongCheng\TCPXieYi_img01.png)

首先我们先来看一下TCP报文的格式，整体上TCP报文属于IP报文的一部分。TCP数据包在IP数据包的负载里面。IP数据包又在以太网数据包里面。

![](E:\Workspace\KTKnowledgeBase\Image\WangLuoGongCheng\TCPXieYi_img02.jpeg)



详细的TCP报文格式看下面这张图。

![](E:\Workspace\KTKnowledgeBase\Image\WangLuoGongCheng\TCPXieYi_img03.png)

TCP报头中的源端口号和目的端口号同IP数据报中的源IP与目的IP唯一确定一条TCP连接。

序号（4字节=32位）用来标识TCP发端向TCP收端发送的数据字节流。

确认序号（4字节=32位）：SYN报文，ACK标志为0，没有确认序号。TCP协议规定，只有ACK=1时确认序号才有效，也规定连接建立后所有发送的报文的ACK必须为1。一旦连接建立，该值将始终发送（同ACK标志）。

标志位（Flags）：共6个，即URG、ACK、PSH、RST、SYN、FIN。

- URG：长1位，表示紧急指针字段有效。
- ACK：长1位，置位表示确认号字段有效；TCP协议规定，只有ACK=1时有效，也规定连接建立后所有发送的报文的ACK必须为1。
- PSH：长1位，表示当前报文需要请求推（push）操作。
- RST：长1位，置位表示复位TCP连接。
- SYN：长1位，在连接建立时用来同步序号。当SYN=1而ACK=0时，表明这是一个连接请求报文。对方若同意建立连接，则应在响应报文中使SYN=1和ACK=1。因此，SYN置1就表示这是一个连接请求或连接接受报文。
- FIN：长1位，用于释放TCP连接时标识发送方比特流结束。用来释放一个连接。当FIN=1时，表明此报文段的发送方的数据已经发送完毕，并要求释放连接。

窗口大小：长度为16位，2个字节。

校验和：长度为16位，2个字节。

紧急指针：长度为16位，2个字节。

以上是TCP包头必须要有的字段，也称固有字段，长度为20个字节。

### 数据传输

TCP数据传输的过程需要对方响应确认就是返回ack。如果没收到ack，这个时候有两种情况，一个是请求就没到，第二个是响应没回来，这两种情况下都会重新传一次，这就是TCP重传。一串连续的请求的响应可以不用一一回复，回复一次就可以，这就是批量ack。但是一串连续的请求也不能太多，太多了对方来不及处理，所以二者需要协商好速率，这就是TCP窗口大小。

### ACK

在Linux操作系统中，默认情况下，接收方每收到两个TCP数据包，就要发送一个确认消息。确认的英语是acknowledgement，所以这个确认消息就简称ACK。ACK携带两个信息：1、期待要收到下一个数据包的编号；2、接收方的接收窗口的剩余容量。发送方有了这两个信息，再加上自己已经发出的数据包的最新编号，就会推测出接收方大概的接收速度，从而降低或增加发送速率。这被称为发送窗口，这个窗口的大小是可变的。还要注意，由于TCP通信是双向的，所以双方都需要发送ACK。两方的窗口大小，很可能是不一样的。
