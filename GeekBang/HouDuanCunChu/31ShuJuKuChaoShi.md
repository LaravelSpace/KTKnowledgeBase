```json
{
  "updated_by": "KelipuTe",
  "updated_at": "2020-08-04",
  "tags": "极客时间,GeekBang,后端存储实践课"
}
```

---

## 访问数据库超时和慢SQL

访问数据库超时这个问题是一个非常常见的问题。产生的原因多种多样，数据库本身性能不行；没有使用缓存造成大量查询落在MySQL上，导致MySQL繁忙无法提供服务；慢查询，慢事务导致大量请求阻塞等。这些问题大致可以分成两类大问题。

第一类是SQL编写的问题。在编写SQL的时候就要思考：SQL涉及到的表，它的数据规模是多少；SQL可能会遍历的数据量是多少；尽量避免写出慢查询，或者构造出慢事务。

第二类是缓存的问题。有没有缓存很重要，缓存的命中率也很重要。缓存设计需要尽量避免大量请求穿透缓存落到数据库上，这就需要保证缓存的命中率。

当然遇到上面的问题，我们不能干等着数据库崩掉。需要进行一定程度上的干预，减轻故障对系统的影响。

针对慢SQL，可以上线一个定时监控和杀掉慢SQL的脚本。这个脚本每分钟执行一次，检测上一分钟内，有没有执行时间超过一分钟（这个阈值可以根据实际情况调整）的慢SQL，如果发现，直接杀掉这个会话。这样可以有效地避免一个慢SQL拖垮整个数据库的悲剧。即使出现慢SQL，数据库也可以在至多1分钟内自动恢复，避免数据库长时间不可用。代价是，可能会有些功能，之前运行是正常的，这个脚本上线后，就会出现问题。不过这个代价是值得的，可以督促开发人员避免写出慢SQL。

针对已经崩了的情况，可以做一个简单的静态页面的首页作为降级方案，只要包含商品搜索栏、大的品类和其他顶级功能模块入口的链接就可以了，不涉及到崩了的这个模块的数据库的交互。然后在Nginx上做一个策略，如果请求首页数据超时的时候，直接返回这个静态的首页作为替代。这样至少不会影响到用户使用其他功能。

### 慢SQL

严重的时候一个慢SQL就可以直接让MySQL瘫痪。所谓慢SQL，就是执行特别慢的SQL语句。虽然并没有一个非常明确的标准或者说是界限去定义慢SQL，但是在大多数实际的系统中，慢SQL消耗掉的数据库资源，往往是正常SQL的几倍、几十倍甚至几百倍，所以还是非常容易区分的。但问题是，我们不能等着系统上线，慢SQL吃光数据库资源之后，再找出慢SQL来改进，那样就晚了，所以要事先预防。

### 定量认识MySQL

一般一台MySQL服务器，平均每秒钟执行的SQL数量在几百左右，就已经是非常繁忙了，即使看起来CPU利用率和磁盘繁忙程度没那么高，你也需要考虑给数据库减负了。

慢SQL对数据库的影响，是一个量变到质变的过程，对量的把握，就很重要。作为一个合格的程序员，你需要对数据库的能力，有一个定量的认识。影响MySQL处理能力的因素很多，比如：服务器的配置、数据库中的数据量大小、MySQL的一些参数配置、数据库的繁忙程度等等。但是，通常情况下，这些因素对于MySQL性能和处理能力影响范围，大概在几倍的性能差距。所以，我们不需要精确的性能数据，只要掌握一个大致的量级，就足够指导我们的开发工作了。

到底多慢的SQL才算慢SQL。这里面这个“慢”，衡量的单位本来是执行时长，但是时长这个东西，我们在编写SQL的时候并不好去衡量。那我们可以用执行SQL查询时，需要遍历的数据行数替代时间作为衡量标准，因为查询的执行时长基本上是和遍历的数据行数正相关的。

在编写一条查询语句的时候，可以依据你要查询数据表的数据总量，估算一下这条查询大致需要遍历多少行数据。如果遍历行数在百万以内的，只要不是每秒钟都要执行几十上百次的频繁查询，可以认为是安全的。遍历数据行数在几百万的，查询时间最少也要几秒钟，你就要仔细考虑有没有优化的办法。遍历行数达到千万量级和以上的，这种查询就不应该出现在在线系统中。

遍历行数在千万左右，是MySQL查询的一个坎儿。MySQL中单个表数据量，也要尽量控制在一千万条以下，最多不要超过二三千万这个量级。原因也很好理解，对一个千万级别的表执行查询，加上几个WHERE条件过滤一下，符合条件的数据最多可能在几十万或者百万量级，这还可以接受。但如果再和其他的表做一个联合查询，遍历的数据量很可能就超过千万级别了。

### 使用索引避免全表扫描

使用索引可以有效地减少执行查询时遍历数据的行数，提高查询性能。绝大多数情况下，我们编写的查询语句，都应该使用索引，避免去遍历整张表，也就是通常说的，避免全表扫描。你在每次开发新功能，需要给数据库增加一个新的查询时，都要评估一下，是不是有索引可以支撑新的查询语句，如果有必要的话，需要新建索引来支持新增的查询。

但是，增加索引付出的代价是，会降低数据插入、删除和更新的性能。这个是因为，增加了索引，在数据变化的时候，不仅要变更数据表里的数据，还要去变更每个索引。所以，对于更新频繁并且对更新性能要求较高的表，可以尽量少建索引。而对于查询较多更新较少的表，可以根据查询的业务逻辑，适当多建一些索引。

### 分析SQL执行计划

MySQL和大部分数据库，都提供一个帮助我们分析查询功能：执行计划。在MySQL中使用执行计划也非常简单，只要在你的SQL语句前面加上EXPLAIN关键字，然后执行这个查询语句就可以了。这个功能可以帮助你了解MySQL在执行的过程中会用到哪个索引，大致会扫描多少行。