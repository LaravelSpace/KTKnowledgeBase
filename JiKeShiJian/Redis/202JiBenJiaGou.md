## 基本架构

### Redis知识全景

Redis是应用非常广泛的键值数据库。Redis知识全景图简单来说包括，两大维度，三大主线。两大维度就是指系统维度和应用维度，三大主线也就是指高性能、高可靠和高可扩展。高性能主线包括线程模型、数据结构、持久化、网络框架；高可靠主线，包括主从复制、哨兵机制；高可扩展主线，包括数据分片、负载均衡。

![](E:\GongZuoQu\KTZhiShiKu\TuPian\JiKeShiJian\Redis\JiBenJiaGou_img02.jpg)

### Redis问题画像图

![](E:\GongZuoQu\KTZhiShiKu\TuPian\JiKeShiJian\Redis\JiBenJiaGou_img04.jpeg)

学习Redis，存在一个误区，只关注零散的技术点，没有建立起一套完整的知识框架，缺乏系统观。系统观其实是至关重要的。从某种程度上说，在解决问题时，拥有了系统观，就意味着你能有依据、有章法地定位和解决问题。

### 键值数据库的大体架构

大体来说，一个简单的键值数据库包括了访问框架、索引模块、操作模块和存储模块四部分。

![](E:\GongZuoQu\KTZhiShiKu\TuPian\JiKeShiJian\Redis\JiBenJiaGou_img06.jpg)

#### 访问模式

访问模式通常有两种：一种是通过函数库调用的方式供外部应用使用，比如以动态链接库的形式链接到程序中；另一种是通过网络框架以Socket通信的形式对外提供操作。不同的键值数据库服务器和客户端交互的协议并不相同，我们在对键值数据库进行二次开发时，必须要了解和掌握键值数据库的通信协议，这样才能开发出兼容的客户端。

通过网络框架提供键值存储服务，一方面扩大了键值数据库的受用面，但另一方面，也给键值数据库的性能、运行模型提供了不同的设计选择，带来了一些潜在的问题。键值数据库网络框架接收到网络包，并按照相应的协议进行解析之后，就可以知道客户端想干什么。此时，会遇到一个系统设计上的问题，简单来说，就是网络连接的处理、网络请求的解析，以及数据存取的处理，是用一个线程、多个线程，还是多个进程来交互处理呢？该如何进行设计和取舍呢？我们一般把这个问题称为I/O模型设计。不同的I/O模型对键值数据库的性能和可扩展性会有不同的影响。

如果一个线程既要处理网络连接、解析请求，又要完成数据存取，一旦某一步操作发生阻塞，整个线程就会阻塞住，这就降低了系统响应速度。如果我们采用不同线程处理不同操作，那么，某个线程被阻塞时，其他线程还能正常运行。但是，不同线程间如果需要访问共享资源，那又会产生线程竞争，也会影响系统效率，这又该怎么办呢？所以，这的确是个两难选择，需要我们进行精心的设计。

#### 索引模块

知道了要进行的键值对操作，此时，需要查找所要操作的键值对是否存在，这依赖于键值数据库的索引模块。索引的作用是让键值数据库根据key找到相应value的存储位置，进而执行操作。索引的类型有很多，常见的有哈希表、B+树、字典树等。不同的索引结构在性能、空间消耗、并发控制等方面具有不同的特征。不同键值数据库采用的索引并不相同，例如，Memcached和Redis采用哈希表作为key-value索引，而RocksDB则采用跳表作为内存中key-value的索引。

一般而言，内存键值数据库（例如Redis）采用哈希表作为索引，很大一部分原因在于，其键值数据基本都是保存在内存中的，而内存的高性能随机访问特性可以很好地与哈希表O(1)的操作复杂度相匹配。对于Redis而言，它的value支持多种类型，当通过索引找到一个key所对应的value后，仍然需要从value的复杂结构（例如集合和列表）中进一步找到实际需要的数据，这个操作的效率本身依赖于它们的实现结构。

#### 操作模块

找到存储位置之后，需要进一步执行的操作的具体逻辑会有所差异。对于GET操作而言，此时根据value的存储位置返回value值即可；对于SET一个新的键值对数据而言，需要为该键值对分配内存空间；对于DELETE操作，需要删除键值对，并释放相应的内存空间，这个过程由分配器完成。

#### 存储模块

分配器是键值数据库中的一个关键因素。常用的内存分配器有glibc的malloc和free。但是，键值数据库的键值对通常大小不一，glibc 的分配器在处理随机的大小内存块分配时，表现并不好。一旦保存的键值对数据规模过大，就可能会造成较严重的内存碎片问题。

键值数据库通常依赖内存保存数据，提供快速访问。但是，在意外重启时，内存中的数据会全部丢失，所以，如果想要在意外重启后能快速重新提供服务，那么，存储模块中就需要有持久化功能。

### Redis的架构

![](E:\GongZuoQu\KTZhiShiKu\TuPian\JiKeShiJian\Redis\JiBenJiaGou_img08.jpg)

从这张对比图中，我们可以看到从简单兼职数据库演进到Redis，有以下几个重要变化。

- Redis主要通过网络框架进行访问，而不再是动态库了，这也使得Redis可以作为一个基础性的网络服务进行访问，扩大了Redis的应用范围。
- Redis 数据模型中的value类型很丰富，因此也带来了更多的操作接口，例如面向列表的LPUSH/LPOP，面向集合的  SADD/SREM等。
- Redis的持久化模块能支持两种方式：日志（AOF）和快照（RDB），这两种持久化方式具有不同的优劣势，影响到 Redis  的访问性能和可靠性。
- Redis支持高可靠集群和高可扩展集群，因此，Redis中包含了相应的集群功能支撑模块。