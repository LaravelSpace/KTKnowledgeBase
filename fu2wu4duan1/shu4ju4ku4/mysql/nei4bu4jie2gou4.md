## MySQL内部结构

### 基础架构

MySQL由连接池、SQL接口、解析器、优化器、缓存、存储引擎等组成，可以分为三层，即MySQL Server层、存储引擎层和文件系统层。MySQL Server层又包括连接层和SQL层。下图是官方文档中MySQL的基础架构图：

![](E:\GongZuoQu\ZhiShiKu\tu2pian4\fu2wu4duan1\shu4ju4ku4\mysql\mysql0nei4bu4jie2gou4.png)

Connectors不属于以上任何一层，可以将Connectors理解为各种客户端、应用服务，主要指的是不同语言与SQL的交互。

Connection pool为连接层，Management Services & Utilities...Caches & Buffers为SQL层，Pluggable Storage Engines为存储引擎层，Filesystem、Files & Logs为文件系统层。

##### 连接层

应用程序通过接口（如ODBC、JDBC）来连接MySQL，最先连接处理的是连接层。连接层包括通信协议、线程处理、用户名密码认证3部分。

- 通信协议负责检测客户端版本是否兼容MySQL服务端。
- 线程处理是指每一个连接请求都会分配一个对应的线程，相当于一条SQL对应一个线程，一个线程对应一个逻辑CPU，在多个逻辑CPU之间进行切换。
- 密码认证用来验证用户创建的账号、密码，以及host主机授权是否可以连接到MySQL服务器。

Connection Pool（连接池）属于连接层。由于每次建立连接都需要消耗很多时间，连接池的作用就是将用户连接、用户名、密码、权限校验、线程处理等需要缓存的需求缓存下来，下次可以直接用已经建立好的连接，提升服务器性能。

##### SQL层

SQL层是MySQL的核心，MySQL的核心服务都是在这层实现的。主要包含权限判断、查询缓存、解析器、预处理、查询优化器、缓存和执行计划。

- 权限判断可以审核用户有没有访问某个库、某个表，或者表里某行数据的权限。
- 查询缓存通过Query Cache进行操作，如果数据在Query Cache中，则直接返回结果给客户端，不必再进行查询解析、优化和执行等过程。
- 查询解析器针对SQL语句进行解析，判断语法是否正确。
- 预处理器对解析器无法解析的语义进行处理。
- 查询优化器对SQL进行改写和相应的优化，并生成最优的执行计划，就可以调用程序的API接口，通过存储引擎层访问数据。


Management Services & Utilities、SQL Interface、Parser、Optimizer和Caches & Buffers属于SQL层，详细说明如下表所示。

| 名称                            | 说明                                                         |
| ------------------------------- | ------------------------------------------------------------ |
| Management Services & Utilities | MySQL的系统管理和控制工具，包括备份恢复、MySQL复制、集群等。 |
| SQL Interface（SQL接口）        | 用来接收用户的SQL命令，返回用户需要查询的结果。例如SELECTFROM就是调用SQL Interface。 |
| Parser（查询解析器）            | 在SQL命令传递到解析器的时候会被解析器验证和解析，以便MySQL优化器可以识别的数据结构或返回SQL语句的错误。 |
| Optimizer（查询优化器）         | SQL语句在查询之前会使用查询优化器对查询进行优化，同时验证用户是否有权限进行查询，缓存中是否有可用的最新数据。它使用选取-投影-连接策略进行查询。例如`SELECT id,name FROM student WHERE gender="女";`语句中，SELECT查询先根据WHERE语句进行选取，而不是将表全部查询出来以后再进行gender过滤。SELECT查询先根据id和name进行属性投影，而不是将属性全部取出以后再进行过滤，将这两个查询条件连接起来生成最终查询结果。 |
| Caches & Buffers（查询缓存）    | 如果查询缓存有命中的查询结果，查询语句就可以直接去查询缓存中取数据。这个缓存机制是由一系列小缓存组成的，比如表缓存、记录缓存、key缓存、权限缓存等。 |

##### 存储引擎层

Pluggable Storage Engines属于存储引擎层，主要负责MySQL中数据的存储和提取。因为在关系数据库中，数据的存储是以表的形式存储的，所以存储引擎也可以称为表类型（即存储和操作此表的类型）。

##### 文件系统层

文件系统层主要是将数据库的数据存储在操作系统的文件系统之上，并完成与存储引擎的交互。

### 一个请求的执行过程

##### 连接层

连接处理：客户端同数据库服务层通过连接管理模块建立TCP连接，并请求一个连接线程。如果连接池中有空闲的连接线程，则分配给这个连接，如果没有，在没有超过最大连接数的情况下，创建新的连接线程负责这个客户端。

连接管理模块负责监听对MySQL Server的各种请求，接收连接请求，转发所有连接请求到线程管理模块。每一个连接上MySQL Server的客户端请求都会被分配（或创建）一个连接线程为其单独服务。而连接线程的主要工作就是负责MySQL Server与客户端的通信，接收客户端的命令请求，传递Server端的结果信息等。线程管理模块则负责管理维护这些连接线程。包括线程的创建，线程的缓存等。

授权认证：在真正的操作之前，还需要调用用户模块进行授权检查，来验证用户是否有权限。用户模块所实现的功能，主要包括用户的登录连接权限控制和用户的授权管理。验证通过后，连接线程开始接收并处理来自客户端的请求。

在MySQL中，将客户端请求分为了两种类型：一种是query（SQL语句），需要调用Parser（查询解析器）才能够执行的请求；一种是command（命令），不需要调用Parser就可以直接执行的请求。

##### SQL层

连接线程接收到SQL语句之后，将语句交给Parser进行语法分析和语义分析。之后根据类型的不同，有些会直接处理，有些会分发给其他模块来处理。如果是一个query类型的请求，会将控制权交给Query解析器。Query解析器首先分析是不是一个Select类型的query。

如果是query类型，则调用查询缓存模块，让它检查该query在Query Cache（查询缓存）中是否已经存在，如果有结果可以直接返回给客户端。没有结果则将控制权交给Optimizer（查询优化器），进行查询的优化。如果是表变更语句，则分别交给Insert处理器、Delete处理器、Update处理器、Create处理器，以及Alter处理器这些小模块来负责。

##### 存储引擎层

在各个模块收到Query解析或其它模块分发过来的请求后，首先会通过访问控制模块检查连接用户是否有访问目标表以及目标字段的权限，如果有，就会调用表管理模块请求相应的表，并获取对应的锁。表变更管理模块主要是负责完成一些DML和DDL的query，如：update，delete，insert，create table，alter table等语句的处理。

当表变更管理模块获取打开的表之后，就会根据该表的相关信息，判断表的存储引擎类型和其他相关信息。根据表的存储引擎类型，提交请求给存储引擎接口模块，调用对应的存储引擎实现模块，进行相应处理。

不过，对于表变更管理模块来说，可见的仅是存储引擎接口模块所提供的一系列标准接口，底层存储引擎实现模块的具体实现，对于表变更管理模块来说是透明的。他只需要调用对应的接口，并指明表类型，之后接口模块会根据表类型调用正确的存储引擎来进行相应的处理。

当一条query或者一个command处理完成（成功或者失败）之后，控制权都会交还给连接线程模块。

如果处理成功，则将处理结果（可能是一个Result Set，也可能是成功或者失败的标识）通过连接线程反馈给客户端。如果处理过程中发生错误，也会将相应的错误信息发送给客户端，然后连接线程模块会进行相应的清理工作，并继续等待后面的请求。之后重复上面的过程，或者与客户端断开连接，最后关闭连接，释放连接线程。
